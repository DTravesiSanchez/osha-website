From 48a998d096ec073306fa4914cc11d92163fa856a Mon Sep 17 00:00:00 2001
From: Claudia Ifrim <ifrim.claudia@gmail.com>
Date: Mon, 13 Oct 2014 13:42:48 +0300
Subject: [PATCH] add redirect /view for migrated publications

---
 .../content.publications.migrate.inc               | 35 ++++++++++++++++++++++
 1 file changed, 35 insertions(+)

diff --git a/docroot/sites/all/modules/osha/osha_migration/content.publications.migrate.inc b/docroot/sites/all/modules/osha/osha_migration/content.publications.migrate.inc
index 6ed15d3..a6acddf 100644
--- a/docroot/sites/all/modules/osha/osha_migration/content.publications.migrate.inc
+++ b/docroot/sites/all/modules/osha/osha_migration/content.publications.migrate.inc
@@ -340,6 +340,41 @@ class OshaMigratePublications extends OSHADynamicMigration {
       }
     }
   }
+
+
+  /**
+   * Sets the node aliases after the migration, nid is available.
+   *
+   * @param object $entity
+   *   Entity to be saved
+   * @param object $row
+   *   Source row
+   */
+  public function complete($entity, $row) {
+    parent::complete($entity, $row);
+
+    $languages = array_keys($entity->translations->data);
+    if (!in_array($row->language, $languages)) {
+      $languages[] = $row->language;
+    }
+
+    foreach ($languages as $language) {
+      if (isset($row->path[$language])) {
+        // create redirect from publication's/view path to publication's path
+        $redirect = new stdClass();
+        $redirect->source = $row->path[$language] . '/view';           // From URL
+        $redirect->source_options = array();
+        $redirect->redirect = 'node/'.$entity->nid;                    // To URL
+        $redirect->redirect_options = array();
+        $redirect->status_code = 0;                                    // Redirect Status
+        $redirect->type = 'redirect';
+        $redirect->language = $language;
+
+        // Create the redirect
+        redirect_save($redirect);
+      }
+    }
+  }
 }
 
 /**
-- 
1.8.4.msysgit.0

