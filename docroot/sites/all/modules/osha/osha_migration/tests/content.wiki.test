<?php

/**
 * Class WikiParseTest tests parsing of the wiki articles
 */
class WikiParseTest extends DrupalUnitTestCase {

  /**
   * Test information.
   *
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name' => 'OSHA wiki parse testing',
      'description' => 'Tests the Wiki migration',
      'group' => 'OSHA',
    );
  }

  public function testWikiParse() {
  
    $OSHWIKI_PREFIX = 'http://oshwiki.eu/wiki/';
  
    $source_file = drupal_get_path('module', 'osha_migration') . '/data/test/wiki.json';
    $json = json_decode(file_get_contents($source_file), TRUE); 
    $text = $json['parse']['wikitext']['*'];
    
    $pattern = '/{{.*}}(\n\[\[[^\]]*\]\])*(\n<[^\n]*)*\n(.*)/s';
    $matches = array();
    preg_match_all($pattern, $text, $matches);
    $wiki_text = $matches[3][0];
    $lines = preg_split('/\n/', $wiki_text);
    $char_count = 0;
    
    // replace wiki formatting with HTML
    $patterns = array();
    // == Headings ==
    $patterns[0] = '/==== ([^=]*) ====/';
    $patterns[1] = '/=== ([^=]*) ===/';
    $patterns[2] = '/== ([^=]*) ==/';
    // internal [[Wiki Links]]
    $patterns[3] = '/\[\[([^\]]*)\]\]/';
    // '''''bold+italic''''', '''bold''', ''italic''
    $patterns[4] = "/'''([^']*)'''/";
    $patterns[5] = "/''([^']*)''/";
    // replace http links
    $patterns[6] = "/\[([^\s\[]*)\s([^\[]*)\]/";
    // remove unwanted <ref/>
    $patterns[7] = "/<ref.*\/>/";
    
    
    $replacements = array();
    $replacements[0] = '<h4>${1}</h4>';
    $replacements[1] = '<h3>${1}</h3>';
    $replacements[2] = '<h2>${1}</h2>';
    $replacements[3] = '<a href="'.$OSHWIKI_PREFIX.'${1}">${1}</a>';
    $replacements[4] = '<b>${1}</b>';
    $replacements[5] = '<i>${1}</i>';
    $replacements[6] = '<a href="${1}">${2}</a>';
    $replacements[7] = '${1}';

    $summary = '';
    foreach ($lines as $line) {
      if ($length = strlen($line)) {
        $char_count += $length;
        $summary .= "<p>".preg_replace($patterns, $replacements, $line)."</p>\n";
        // limit maximum char length
        if ($char_count > 700) {
          break;
        }
      }
    }
  }
}