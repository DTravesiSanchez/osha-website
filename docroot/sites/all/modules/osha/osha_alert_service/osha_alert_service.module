<?php

class OshaAlertServiceMailSystem extends DefaultMailSystem {
  /**
   * {@inheritdoc}
   */
  public function format(array $message) {
    $message['body'] = implode("\n\n", $message['body']);
    $message['body'] = drupal_wrap_mail($message['body']);
    return $message;
  }
}

/**
 * Implements hook_entity_info().
 */
function osha_alert_service_entity_info() {
  $info = array();
  $info['osha_alert_service'] = array(
    'label' => t('OSHA Alert'),
    'base table' => 'osha_alert_service',
    'entity keys' => array(
      'id' => 'id',
    ),
    'module' => 'osha_alert_service',
    'entity class' => 'Entity',
    'controller class' => 'EntityAPIController',
  );
  return $info;
}

/**
 * Load a single entity of type osha_alert_service by its token.
 *
 * @param string $token
 *   Secret token.
 *
 * @return mixed
 *   An array of entity objects indexed by their ids. When no results are
 *   found, an empty array is returned.
 */
function osha_alert_service_osha_alert_service_load_by_token($token) {
  $query = db_select('osha_alert_service', 's')
    ->fields('s', array('id'))
    ->condition('token', $token);
  $ids = $query->execute()->fetchCol(0);
  if (isset($ids[0])) {
    return entity_load_single('osha_alert_service', $ids[0]);
  }
  return NULL;
}

/**
 * Implements hook_menu().
 */
function osha_alert_service_menu() {
  $menu['alertservice/verify_alert'] = array(
    'title' => 'Validate Alert Service Subscription',
    'description' => 'Endpoint where subscribers validate their subscription',
    'page callback' => 'osha_alert_service_verify_alert_form',
    'page arguments' => array(),
    'access arguments' => array('view published content'),
    'type' => MENU_LOCAL_TASK,
    'weight' => -12,
    'file' => 'osha_alert_service.forms.inc',
  );
  $menu['alertservice/remove_alert'] = array(
    'title' => 'Remove Alert Service Subscription',
    'description' => 'Endpoint where subscribers remove from subscription',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('osha_alert_service_remove_alert_form'),
    'access arguments' => array('view published content'),
    'type' => MENU_LOCAL_TASK,
    'weight' => -12,
    'file' => 'osha_alert_service.forms.inc',
  );
  return $menu;
}

/**
 * Implements hook_block_info().
 */
function osha_alert_service_block_info() {
  $path = drupal_lookup_path('source', 'alertservice');
  $pages = 'alertservice';
  if ($node = menu_get_object('node', 1, $path)) {
    $pages .= "\r\nnode/" . $node->nid;
  }
  return array(
    'osha_alert_service_subscribe' => array(
      'info' => 'Alert Service Subscription',
      'cache' => DRUPAL_CACHE_GLOBAL,
      'status' => 1,
      'region' => 'content',
      'visibility' => BLOCK_VISIBILITY_LISTED,
      'pages' => $pages,
    ),
  );
}

/**
 * Implements hook_block_view().
 *
 * {@inheritdoc}
 */
function osha_alert_service_block_view($delta = '') {
  module_load_include('inc', 'osha_alert_service', 'osha_alert_service.forms');
  $ret = array();
  switch ($delta) {
    case 'osha_alert_service_subscribe':
      $form = drupal_get_form('osha_alert_service_subscribe_form');
      $ret['content'] = array(
        '#type' => 'item',
        '#markup' => drupal_render($form),
      );
      break;
  }
  return $ret;
}

/**
 * Implements hook_mail().
 *
 * {@inheritdoc}
 */
function osha_alert_service_mail($key, &$message, $params) {
  global $base_url;
  $keys = array();
  $params['base_url'] = $base_url;
  foreach ($params as $k => $v) {
    $keys[] = '[' . $k . ']';
  }

  switch ($key) {
    case 'subscribe':
      $subject = variable_get('osha_mail_template_alert_service_subscribe_subject', 'Your subscription to OSHA Alert Service');
      $body = variable_get('osha_mail_template_alert_service_subscribe_body',
<<<EOT
EU-OSHA received a request to start sending alerts to [email].

Verify this EU-OSHA alert request: [base_url]/[language]/alertservice/verify_alert?token=[token]
Cancel this EU-OSHA alert request: [base_url]/[language]/alertservice/remove_alert?token=[token]
If you are not able to click on the link, you can cut and paste it into your browser's address bar.

If you did not initiate this request or believe it was sent in error you can safely ignore this message.
Thanks,
The EU-OSHA Alerts Team
EOT
      );
      $message['subject'] = $subject;
      $message['body'] = str_replace($keys, array_values($params), $body);
      break;

    case 'broken_subscription':
      $subject = 'Your subscription page is broken';
      $body = <<<EOT
        Please visit the subscription page ($base_url/alertservice) and fix it. Taxonomy Tags is empty!

        Thank you,
        Your faithful employee.
EOT;
      $message['subject'] = $subject;
      $message['body'] = str_replace($keys, array_values($params), $body);
      break;
  }
}
